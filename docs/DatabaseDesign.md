# 数据库表结构设计

---

## 节点表 tb_node

用于管理节点记录已注册的执行节点信息

| 字段名           | 字段类型         | 字段说明                                       | 备注                                                    |
| :--------------- | :--------------- | :--------------------------------------------- | :------------------------------------------------------ |
| id               | char             | 已注册执行节点的唯一ID                         | 由管理节点通过算法生成, 非数据库自增ID                  |
| node_ip          | char             | 已注册执行节点的IP地址                         | 由执行节点向管理节点注册时提交                          |  |
| node_registed_at | 执行节点注册时间 | 由管理节点在执行节点进行注册时读取系统当前时间 |                                                         |
| node_status      | char             | 当前执行节点的状态                             | 由执行节点定时上报, 可选值: DISCONNECTED, IDEL, WORKING |

涉及的操作

- INSERT

    执行节点注册时, 检查制定的IP是否有记录, 没有时执行

- UPDATE

    - 执行节点定时上报状态时如果上报的状态与当前库中记录不同时执行
    - 执行节点注册时执行

- SELECT

    管理节点分发作业前执行

## 任务表 tb_task

用于RPC服务和管理节点记录任务信息

| 字段名        | 字段类型 | 字段说明               | 备注                                                     |
| :------------ | :------- | :--------------------- | :------------------------------------------------------- |
| id            | char     | 任务唯一ID             | 由RPC服务接到任务请求后通关算法生成                      |
| task_file     | char     | 转码原始文件路径       | RPC服务收到的转码请求中提交或RPC服务通过其他文件服务获取 |
| task_metadata | text     | 转码原始文件元信息     | 由管理节点解析获取                                       |
| task_status   | char     | 转码任务状态           | 可选值: QUEUING, RUNNING, FINISHED, FAILED               |
| task_callback | char     | 转码结束后回调通知地址 | RPC服务收到的转码请求中提交                              |

涉及的操作

- INSERT

    RPC服务收到转码请求时执行

- UPDATE

    - 管理节点完成任务分析后执行, 更新task_metadata
    - 管理节点分发作业后执行, 更新task_status
    - 管理节点完成任务后执行, 更新task_status

- SELECT

    - 管理节点从队列中读取到消息后执行

## 作业表 tb_job

用于管理节点记录作业信息

| 字段名      | 字段类型 | 字段说明             | 备注                                        |
| :---------- | :------- | :------------------- | :------------------------------------------ |
| id          | char     | 作业唯一ID           | 由管理节点分发作业时通过算法生成            |
| job_task_id | char     | 关联任务ID           | tb_task表外键                               |
| job_node_id | char     | 作业委派的作业节点ID | tb_node表外键                               |
| job_status  | char     | 作业状态             | 可选值: RUNNING, FINISHIED, REREING, FAILED |
| job_retried | int      | 作业重试次数         |                                             |
| job_file    | char     | 作业执行的源文件路径 |                                             |
| job_args    | char     | 作业执行的参数列表   |                                             |
| job_log     | char     | 作业执行日志文件路径 |                                             |

涉及的操作

- INSERT

    管理节点分发任务前执行

- UPDATE

    - 执行节点执行成功结束上报作业状态时执行, 更新 job_status
    - 管理节点分发作业后执行, 更新 job_status
    - 执行节点执行失败上报作业状态时执行, 更新 job_status, job_retried

- SELECT

    - 执行节点执行成功结束上报作业状态时执行