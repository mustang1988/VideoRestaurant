@startuml Sequence Design

actor Client
entity Storage
entity Waiter
database Database
queue TaskQueue
entity Chef
entity Assistant
queue CallbackQueue

autonumber

group Phase Service Startup
    activate Chef
    Chef -> Chef: Startup service Chef, listening to a port, on websocket
    activate Assistant
    Assistant -> Assistant: Startup service Assistant
    Assistant -> Chef : Connecting to Chef, if success, send a regist message to Chef
    note left
    ws.send({
        type:'regist',
        ip:'Assistant IP'
    })
    end note
    Chef -> Chef : Generate a unique ID for Assistant whitch send a regist message to Chef
    Chef -> Database : Save Assistant info to database, set's status to IDEL
    note left
    INSERT INTO 
        tb_node(id,node_ip,status,node_registed_at) 
        VALUES('GeneratedID','Assistant IP',IDEL,Date.now())
    end note
    Chef -> Assistant : Send the unique id generated by Chef, to Assistant
    note left
    ws.send({
        type:'regist',
        id:'GeneratedID'
    })
    end note
    activate Waiter
    Waiter -> Waiter: Startup service Waiter, listening to a port, on GRPC

end

group Phase Task Creation
    Client -> Storage : Upload file to storage
    Client -> Waiter : Send a transcode request
    note left
    Transcode request:
    {
        callback:'Callback URL'
        file: 'File to transcode'
        ... // TODO
    }
    end note
    Waiter -> Waiter : Generate a unique id to transcode task
    Waiter -> Database : Save task info to database
    note left
    INSERT INTO
        tb_task(id,task_file,callback,status)
        VALUES('GeneratedID','File to transcode in request','Callback URL in request',QUEUING)
    end note
    Waiter -> TaskQueue : Push the task to task queue
    note left
    taskQueue.push({
        id:'GeneratedID',
        task_file: 'File to transcode in request',
    })
    end note
end

group Phase Task Execution
    Chef -> TaskQueue : Pull message from task queue
    Chef -> Storage : Read origin file's metadata using ffprobe
    note left
    ffprobe \
    -v \
    0 \
    -of \
    json \
    -show_streams \
    -show_format \
    -i 'source file'
    end note
    Chef -> Database : Save metadata info database
    note left
    UPDATE tb_task SET task_metadata='metadata' WHERE id='task id'
    end note
    Chef -> Chef : Analyze the metadata, build transcode args
    ' Chef -> Database : Save transcode args to database
    ' note left
    ' UPDATE tb_task SET task_args='transcode args' WHERE id='task id'
    ' end note
    Chef -> Chef : Seperate origin file into segments, segment count equals to how many assistants are IDEL
    Chef -> Database: Save segment info to database
    note left
    INSERT INTO 
        tb_job(id,job_task_id,job_node_id,job_status,job_retried,job_file,job_args,job_log)
        VALUES(...)
    end note
    Chef -> Assistant: Send job info to assistants
    note left
    ws.send({
        type:'job',
        id:'job id',
    })
    end note
    Assistant -> Chef : Response status after receive job
    Chef -> Database : Update job
    note left
    UPDATE tb_job SET job_node_id="node id" WHERE id='job id'
    end note
    Assistant -> Assistant: Execute transcode job
    Assistant -> Chef : Push job status after execution finished
    note left
    ws.send({
        type:'job',
        id:'job id',
        status:'FINISHED'
    })
    end note
    Chef -> Database: Update job
    note left
    UPDATE tb_job SET job_status='FINISHED' WHERE id='job id'
    end note
    Chef -> Chef : Concat job outputs into single file when all jobs has been finished
    note left
    ffmpeg concat
    end note
    Chef -> Database: Update task status
    note left
    UPDATE tb_task SET task_status='FINISHED' WHERE id='task id'
    end note
    Chef -> CallbackQueue : Push task result into callback queue
    note left
    callbackQueue.push({
        id:'task id',
        result:'',
        callback:'Callback URL in request'
    })
    end note
end

group Phase Callback Notification
    Waiter -> CallbackQueue : Pop message from callback queue
    Waiter -> Client : Call callback URL with transcode result
end

@enduml